image: docker:latest  # âœ… Cháº¡y pipeline trÃªn Docker image (khÃ´ng dÃ¹ng Ruby)

stages:
  - test
  - build
  - deploy

services:
  - name: docker:24.0.7-dind
    alias: docker
    command: ["--tls=false"]
variables:
  DOCKER_HOST: "tcp://docker:2375"
  DOCKER_TLS_CERTDIR: ""
  DOCKER_IMAGE: registry.gitlab.com/doc6032106/python-be

.default-docker-config: &default-docker-config
  image: docker:latest
  services:
    - name: docker:24.0.7-dind
      alias: docker
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
  tags:
    - ubuntu

before_script:
  - apk add --no-cache bash curl
  - echo "$CI_GIT_TOKEN" | docker login registry.gitlab.com -u "$CI_GIT_USER" --password-stdin

# ðŸ›  TEST STAGE (Cháº¡y trÃªn táº¥t cáº£ cÃ¡c branch)
# test:
#   <<: *default-docker-config
#   stage: test
#   script:
#     - docker build -t be-test .
#     - docker run -d --name be-container be-test
#     # - docker exec be-container yarn test
#     - docker stop be-container
#     - docker rm be-container

# ðŸ“¦ BUILD STAGE (Chá»‰ cháº¡y trÃªn branch `main` náº¿u test thÃ nh cÃ´ng)
build:
  <<: *default-docker-config
  stage: build
  only:
    - main  # Chá»‰ cháº¡y khi branch lÃ  `main`
  script:
    - docker build -t $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA -t $DOCKER_IMAGE:latest -f Dockerfile .
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_IMAGE:latest

# ðŸš€ DEPLOY STAGE (Chá»‰ cháº¡y trÃªn `main` sau khi build thÃ nh cÃ´ng)
deploy_trigger:
  stage: deploy
  tags:
    - ubuntu
  before_script:
    - apk add --no-cache curl  # CÃ i curl cho Alpine
  only:
    - main
  script:
    - curl -X POST -F "token=$DEPLOY_TOKEN" -F "ref=main" https://gitlab.com/api/v4/projects/67597499/trigger/pipeline